\chapter{Paralelizace}

Buď $ A $ celočíselná matice $ n \times m $ a předpokládejme, že $ n < m $. Pak
z Hadamardovy nerovnosti (pro bližší infromace čtenáře odkazujeme na publikaci
\cite{Hadamard}) plyne, že $ \det(A) \leq (m^{1/2} \Vert A \Vert )^m $, kde
$ \Vert A \Vert $ značí nejmenší celé číslo takové, že
$ \vert a^i_j \vert \leq \Vert A \Vert $. Z článku \cite{Had_tight} plyne, že
Hadamardův odhad je poněkud pesimistický a v případě náhodných matic vychází
determinant v průměru poněkud lépe, přesto však tento odhad dává tušit, že
se v případě počítačové implementace algoritmu pro výpočet Smithova normálního
tvaru můžeme poměrně rychle dostat do problémů s kapacitou celočíselných typů.

To samozřejmě můžeme řešit specializovanými knihovnami, které
reprezentují celé číslo jako třídu zaobalující pole celých čísel. Nicméně
efektivita takového řešení už není ideální a navíc tento přístup zvyšuje
paměťovou náročnost. Hodilo by se nám proto, kdybychom mohli celý výpočet
rozložit na více částí, pro které už by nebylo problém spočítat výsledek pomocí
standardní integerovské aritmetiky a následně všechny částečné vysledky spojit
do hledaného Smithova normálního tvaru. Toho můžeme dosáhnout pomocí Čínské
zbytkové věty.


\begin{vet}[Čínská zbytková věta] \label{Chin_Rem}
Mějme kladná celá čísla $ m_1,\dots,m_k $, která jsou po dvou nesoudělná. Pak
pro libovolnou posloupnost celých čísel $ a_1,\dots,a_k $ existuje nějaké celé
číslo $ x $, které je řešením následující soustavy kongruencí.

\begin{equation}
    \begin{aligned} \label{congrs}
        x &\equiv a_1 \pmod{m_1}                   \\
        x &\equiv a_2 \pmod{m_2}                   \\
          &\mathrel{\makebox[\widthof{=}]{\vdots}}  \\
        x &\equiv a_k \pmod{m_k}                   \\
    \end{aligned}
\end{equation}
%
Navíc pro libovolná dvě řešení $ x_1, x_2 $ uvedené soustavy platí
$ x_1 \equiv x_2 \pmod{m_1 m_2 \cdots m_k} $.
\end{vet}

\begin{proof}
Zaměřme svou pozornost nejprve na existenci řešení. Označme
$ M = m_1 m_2 \cdots m_k $. Pak zřejmě pro každé $ i \in \{1,\dots,k\} $
platí $ \gcd(m_i, M / m_i) = 1 $, protože $ m_i $ jsou po dvou nesoudělná.
Díky tomu můžeme pomocí rozšířeného Euklidova algoritmu najít celá čísla
$ s_i, t_i $ taková, že $ s_i m_i + t_i \frac{M}{m_i} = 1 $. Nyní označme
$ d_i = t_i \frac{M}{m_i} $. Z toho plyne rovnost $ s_i m_i + d_i = 1 $ a navíc
\begin{align*}
d_i \equiv
\left\{
  \begin{array}{lr}
    1 \pmod{ m_j } & : j = i \\
    0 \pmod{ m_j }  & : j \neq i
  \end{array}
\right.
\end{align*}
Skutečně, pokud $ j = i $, tak dostáváme
$ 1 \equiv s_i m_i + d_i \equiv d_i \pmod{m_i} $. Pokud naopak $ j \neq i $, pak
zřejmě $ m_j \mid d_i $ a proto bude $ d_i $ kongruentní s nulou modulo $ m_j $.

Položme $ x = \sum\limits_{i = 1}^{k} a_i d_i $. Pak díky výše uvedené
vlastnosti $ d_i $ bude $ x $ řešením soustavy \eqref{congrs}.

Nechť pro nějaká dvě řešení soustavy \eqref{congrs} platí
$ x_1 \not\equiv x_2 \pmod{m_1 m_2 \cdots m_k} $. Pak ale
$ x_1 \equiv x_2 \pmod{m_i} \Rightarrow m_i \mid x_1 - x_2 $. Protože $ m_i $
jsou po dvou nesoudělná, tak z předchozí implikace dále plyne, že
$ x_1 - x_2 $ bude dělitelné také součinem všech $ m_i $. Tedy
$ M \mid x_1 - x_2 $. To je ovšem spor s předpokladem, který je ekvivalentní
tomu, že $ M \nmid x_1 - x_2 $.
\end{proof}

\begin{dus} \label{Chin_Rem_Iso}
Mějme kladné číslo $ m $ s faktorizací $ m = p_1^{r_1} \cdots p_k^{r_k}$. Pak
existuje izomorfismus okruhů
$ \Zbb / m \Zbb \cong \Zbb / p_1^{r_1} \Zbb \times \cdots \times \Zbb / p_k^{r_k} \Zbb $
\end{dus}
\begin{proof}
Uvažme zobrazení
$ \varphi : \Zbb / m \Zbb \rightarrow \Zbb / p_1^{r_1} \Zbb \times \cdots \Zbb / p_k^{r_k} \Zbb $
definované jako $ \varphi([x]_m) = ([x]_{p_1^{r_1}},\dots, [x]_{p_k^{r_k}}) $.
Ukážeme, že takto definované zobrazení je izomorfismem okruhů.

Mějme libovolný prvek
$ a = ([a_1]_{p_1^{r_1}},\dots, [a_k]_{p_k^{r_k}}) \in \Zbb / p_1^{r_1} \Zbb \times \cdots \Zbb / p_k^{r_k} \Zbb $.
Pak podle věty \ref{Chin_Rem} můžeme nalézt takové $ x \in \Zbb $, že
%
\begin{equation*}
    \begin{aligned}
        x &\equiv a_1 \pmod{p_1^{r_1}}              \\
          &\mathrel{\makebox[\widthof{=}]{\vdots}}  \\
        x &\equiv a_k \pmod{p_k^{r_k}}.           \\
    \end{aligned}
\end{equation*}
%
Pak ale $ \varphi([x]_m) = a $, z čehož plyne, že $ \varphi $ je surjektivní.

Dále předpokládejme, že existují prvky $ x, y \in \Zbb / m \Zbb $ takové, že
$ x \not\equiv y \pmod{m} $ a navíc $ \varphi(x) = \varphi(y) $. To ovšem
znamená, že platí $ x \equiv y \pmod{p_i^{r_i}} $ pro všechna
$ i \in \{1,\dots,k\} $. Proto $ p_i^{r_i} \mid x - y $, ale díky
nesoudělnosti $ p_i^{r_i} $ platí také $ m \mid x - y $, což implikuje
$ x \equiv y \pmod{m} $. To je ale spor s předpokladem. $ \varphi $ je proto
injekce a díky předchozímu odstavci také bijekce.

Nakonec ještě ověříme, že se skutečně jedná o homomorfismus okruhů.
Mějme $ x, y \in \Zbb / m \Zbb $ libovolné. Pak
%
\begin{align*}
    \varphi(x + y) &= ([x + y]_{p_1^{r_1}},\dots, [x + y]_{p_k^{r_k}})  \\
                   &= ([x]_{p_1^{r_1}} + [y]_{p_1^{r_1}},\dots, [x]_{p_k^{r_k}} + [y]_{p_k^{r_k}})  \\
                   &= ([x]_{p_1^{r_1}},\dots, [x]_{p_k^{r_k}}) + ([y]_{p_1^{r_1}},\dots, [y]_{p_k^{r_k}}) \\
                   &= \varphi(x) + \varphi(y).
\end{align*}
%
Platnost rovnosti $ \varphi(x \cdot y) = \varphi(x) \cdot \varphi(y) $ se ověří
analogicky. Zobrazení $ \varphi $ je tedy skutečně izomorfismus okruhů a zkoumané
prostory jsou proto izomorfní.
\end{proof}

Důsledek \ref{Chin_Rem_Iso} nám vlastně říká, že pokud chceme provádět sérii
výpočtů (sčítání, odčítání, násobení) nad celými čísly a jsme dopředu schopni
omezit výsledek nějakým číslem $ m $, tak to můžeme provést paralelně modulo
prvočíselné faktory $ m $. Konkrétně nejprve faktorizujeme $ m $ na mocniny
prvočísel. Pak použijeme zobrazení $ \varphi $ z důkazu důsledku \ref{Chin_Rem_Iso},
čímž získáme výchozí reprezentanty v příslušných okruzích součinu okruhů.
Nyní můžeme paralelně aplikovat operace, které potřebujeme provést a konečně
pomocí konstrukce uvedené v důkazu věty \ref{Chin_Rem} spojíme částečné výsledky
a obdržíme výsledek původní úlohy.


\section{Výběr prvočísel}
Snadno se nahlédne, že výše uvedený Hadamardův odhad můžeme aplikovat i na prvky
matic ve Smithově normálním tvaru. Mějme libovolnou matici $ A $ jako na začátku
této kapitoly a označme $ \beta = (m^{1/2} \Vert A \Vert )^m $. Naším cílem bude
najít prvočísla $ p_1,\dots, p_k $ tak, aby $ \beta < p_1 \cdots p_k $. Zřejmě
bychom mohli postupně brát prvočísla $ 2, 3, 5, 7, /dots $, dokud by uvedená
podmínka nebyla splněna. Takto bychom však dostali prvočísel zbytečně mnoho. Na
druhou stranu chceme, aby tato prvočísla byla dostatečně malá tak, abychom
si pro rozumně velké matice vystačili se standardní 32bitovou reprezentací
celého čísla. Co znamená rozumně velká matice bude zřejmé z následujících řádků.

Rozumný kompromis poskytuje \cite[Lemma 14]{triang}. Autor však tento výsledek
uvádí bez důkazu s odkazem na publikaci, ve které se nám nepodařilo takovéto
tvrzení vůbec najít, a to ani v nějaké obecnější podobě či jako pomocný výsledek
nějakého důkazu. Abychom předešli nejasnostem, dokážeme toto tvrzení v mírně
modifikované podobě pomocí následujícího tvrzení.


\begin{lem}[{\cite[Corollary 3.8]{primes}}] \label{num_primes_src}
Nechť $ \pi(a) = \sum\limits_{p \leq a}{1} $, kde $ p \in \mathbb{P} $. Pak
platí $ 3a / (5 \ln{a}) < \pi(2a) - \pi(a) $ pro všechna $ a \geq 20 \frac{1}{2} $.
\end{lem}

\begin{lem} \label{num_prim}
Buď $ x \geq 2 $ a $ l = 6 + \log_2 \log_2 x $.
Pak existuje nejméně $ \ceil{\frac{2^{l}}{5 (l - 1)}} $ prvočísel $ p $
takových, že $ 2^{l - 1} < p < 2^l $.
\end{lem}
\begin{proof}
Dosazením $ a = 2^{l - 1} $ do lemmatu \ref{num_primes_src} a postupnými úpravami
dostáváme
\begin{align*}
    \pi(2^{l}) - \pi(2^{l - 1}) > \frac{3 \cdot 2^{l - 1}}{5 \ln{2^{l - 1}}}
                                \geq \frac{2^{l}}{5 \log_2{2^{l - 1}}}
                                = \frac{2^{l}}{5 (l - 1)}.
\end{align*}
Použití lemmatu \ref{num_primes_src} je skutečně korektní, neboť
$ l \geq 6 $ z čehož plyne, že $ a \geq 32 $. Z definice funkce $ \pi(a) $ pak
získáme naše tvrzení.
\end{proof}
\begin{dus}
Buď $ \beta $ Hadamardův odhad na determinant tak, jako na začátku této sekce a
nechť $ l = 6 + \log_2 \log_2 \beta $. Pak můžeme najít
$ s = \ceil{\frac{2^{l}}{5 (l - 1)}} $ prvočísel $ \{p_1, \dots, p_s\} $,
která bude možno reprezentovat $ l $-bitovým celým číslem a navíc bude platit
$ \beta < p_1 \cdots p_s $.
\end{dus}
\begin{proof}
Uvažme prvočísla z lemmatu \ref{num_prim} a označme je $ \{p_1, \dots, p_s\} $.
Tato prvočísla můžeme zdola odhadnout $ 2^{l - 1} < p_i $,
z čehož plyne následující výpočet.
\begin{align*}
    p_1 \cdots p_s
        > (2^{l - 1}) ^ s
        \geq 2^{(l - 1) \frac{2^l}{5 (l - 1)}}
        = 2^{\frac{2^{6 + \log_2 \log_2 \beta}}{5}}
        = \beta^{\frac{2^6}{5}} > \beta
\end{align*}
Tím je důkaz hotov až na případ, kdy $ \beta \in \{0, 1\} $. Tyto možnosti ale
nejsou příliš zajímavé neboť v prvním případě je Smithův normální tvar nulová
matice a ve druhém pak skalár - jednička. V obou případech pak můžeme vzít
libovolné prvočíslo, které jistě bude větší než determinant.
\end{proof}

\begin{pozn}
Poznamenejme, že v praxi pro nějakou konkrétní úlohu můžeme mít k dispozici
podstatně lepší odhad na determinant nebo na prvky v hledaném Smithově normálním
tvaru. Uvedený postup pak bude fungovat úplně stejně, jen nahradíme $ \beta $
daným odhadem a dále postupujeme identicky.
\end{pozn}

Předpokládejme, že $ \Vert A \Vert = 100 $. Pak můžeme numericky
vypočítat, že například pro matice o rozměrech $ 10^4 \times 10^4 $ by
nám stačila prvočísla mající nejvýše $ 11 $ bitů, což je pro naše potřeby naprosto
postačující. Předpokládáme, že větší matice již budou nad naše výpočetní
možnosti.

\section{Paralelizace algoritmů pro výpočet Smithova normálního tvaru}
Mějme opět matici $ A $ tak jako na začátku a uvažme prvočísla
$ \{ p_1, \dots, p_s \} $ z předchozí sekce. Článek \cite[Theorem 16]{triang}
uvádí, že všechny operace algoritmu věty \ref{RST_algo} můžeme provést postupně
modulo prvočísla $ p_i $ a nakonec mezivýsledky spojit do hledaného
redukovaného schodovitého tvaru matice $ A $. Autor článku \cite{triang} se
také zabývá tím, jak vypočítat rank profile potřebný pro výpočet redukovaného
schodovitého tvaru pomocí Čínské zbytkové věty. Ukazuje se \cite[Theorem 15]{triang},
že je skutečně možné efektivně rank profile vypočítat pomocí prvočísel $ p_i $
v okruzích $ \Zbb / p_i \Zbb $. Výpočet ekvivalentní trojúhelníkové matice z
matice $ A $ tedy není problém.

Naneštěstí v článku \cite{SNF_Arne} se autor již touto problematikou nezabývá.
Zamysleme se tedy, zda je paralelizace možná také pro algoritmus \ref{SNF_Triang}.
Kroky algoritmu, ve kterých provádíme přičítání nebo odečítání násobku nějakého
řádku či sloupce, využívají standardní algebraické operace z okruhu celých čísel,
a proto použití izomorfismu $ \varphi $ pro výpočet užívající pouze těchto operací
bude korektní.

Ukážeme, že také výpočet a použití největšího společného dělitele je korektní.

\begin{lem}
Mějme izomorfismus
$ \varphi : \Zbb / m \Zbb \rightarrow \Zbb / p_1^{r_1} \Zbb \times \cdots \Zbb / p_k^{r_k} \Zbb $
z věty \ref{Chin_Rem_Iso} a uvažme prvky $ a, b \in \Zbb / m \Zbb $.
Pak platí
$ \gcd(a,b) = \varphi^{-1}(\gcd([a]_{p_1}, [b]_{p_1}), \dots, \gcd([a]_{p_k}, [b]_{p_k})) $.
\end{lem}
\begin{proof}
\end{proof}
Analogicky se nedostaneme do problémů v případě, kdy budeme
na nějaké pozici matice vyrábět největšího společného dělitele,neboť
Euklidův algoritmus je možné implementovat nad maticemi pomocí elementárních
řádkových a sloupcových operací.